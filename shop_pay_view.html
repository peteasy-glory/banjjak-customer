<?
include($_SERVER['DOCUMENT_ROOT']."/include/global.php");
include($_SERVER['DOCUMENT_ROOT']."/include/skin/header.php");

$product_no = (isset($_GET['product_no']))? $_GET['product_no'] : "";
$user_id = (isset($_SESSION['gobeauty_user_id']))? $_SESSION['gobeauty_user_id']:"";
$user_name = (isset($_SESSION['gobeauty_user_nickname']))? $_SESSION['gobeauty_user_nickname']:"";

$order_num = (isset($_GET['no']))? $_GET['no'] : "";

if($order_num != ""){
    $sql = "
		SELECT * 
		FROM tb_item_payment_log
		WHERE order_num = '".$order_num."'
	";
    $result = mysqli_query($connection,$sql);
    $row = mysqli_fetch_array($result);
    $expire_dt = ($row["expire_dt"] != "")? DATE("Y년 m월 d일 H시 i분", STRTOTIME($row["expire_dt"])) : "";
    $ip_cnt = mysqli_num_rows($result);
    if($ip_cnt <= 0){
        ?>
        <script>
            alert("잘못된 접근입니다. 메인페이지로 이동합니다.");
            location.href = "/";
        </script>
        <?php
        return false;
    }
}else{
    ?>
    <script>
        alert("잘못된 접근입니다. 메인페이지로 이동합니다.");
        location.href = "/";
    </script>
    <?php
    return false;
}

$order_status_arr = array(
    "1" => "주문접수",
    "2" => "입금대기",
    "3" => "결제완료",
    "7" => "결제실패",
    "8" => "입금시간만료",
    "9" => "결제취소"
);

$pay_status_arr = array(
    "1" => "상품준비중",
    "2" => "배송준비중",
    "3" => "배송중",
    "4" => "배송완료",
    "8" => "반품",
    "9" => "취소"
);

$pay_status_arr_old = array(
    "1" => "진행중",
    "2" => "입금대기",
    "3" => "상품준비중",
    "4" => "배송준비중",
    "5" => "배송중",
    "6" => "배송완료",
    "7" => "취소",
    "8" => "보류",
    "9" => "실패"
);

$reason_type_arr = array(
    "1" => "단순변심",
    "2" => "상품불량",
    "3" => "제품변경",
    "etc" => "기타"
);

?>

<!-- header -->
<header id="header">		
	<div class="header-left">
		<a href="<?=$_SESSION['backurl2']?>" class="btn-page-ui btn-page-prev"><div class="icon icon-size-24 icon-page-prev">페이지 뒤로가기</div></a>
	</div>
	<div class="page-title">결제/주문 상세내역</div>
</header>
<!-- //header -->

<!-- container -->
<section id="container"> 
	<!-- page-body -->    
	<div class="page-body">
		<!-- user-pay-view -->  
		<div class="user-pay-view">
			<div class="con-title-group">
				<h3 class="con-title">입금대기 &amp; 결제완료</h3>
			</div>
			<!-- 주문번호 -->
			<div class="user-pay-number"><em>주문번호</em><p><?=$order_num ?></p></div>
			<!-- 주문번호 -->
			<!-- 배송지 정보 -->
			<div class="basic-data-group">
				<div class="con-title-group">
					<h4 class="con-title">배송지 정보</h4>
				</div>
				<div class="flex-table read">
					<div class="flex-table-cell">
						<div class="flex-table-item">
							<div class="flex-table-title"><div class="txt">받으시는 분</div></div>
							<div class="flex-table-data">
								<div class="flex-table-data-inner">
									<?=$row['shipping_name'] ?>
								</div>		
							</div>
						</div>
					</div>
					<div class="flex-table-cell">
						<div class="flex-table-item">
							<div class="flex-table-title"><div class="txt">연락처</div></div>
							<div class="flex-table-data">
								<div class="flex-table-data-inner">
                                    <?=$row['shipping_cellphone'] ?>
								</div>		
							</div>
						</div>
					</div>
					<div class="flex-table-cell">
						<div class="flex-table-item">
							<div class="flex-table-title"><div class="txt">받으시는 곳</div></div>
							<div class="flex-table-data">
								<div class="flex-table-data-inner">
                                    <?=$row['shipping_addr']." ".$row['shipping_addr'] ?>
								</div>		
							</div>
						</div>
					</div>
					<div class="flex-table-cell">
						<div class="flex-table-item">
							<div class="flex-table-title"><div class="txt">배송요청사항</div></div>
							<div class="flex-table-data">
								<div class="flex-table-data-inner">
                                    <?=$row['shipping_memo'] ?>
								</div>		
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- //배송지 정보 -->
			<!-- 결제 정보 -->
			<div class="basic-data-group">
				<div class="con-title-group">
					<h4 class="con-title">결제정보</h4>
				</div>				
				<div class="price-data-wrap type-2">
					<div class="price-data-group">
						<div class="price-data-list">	
							<div class="price-data-list-cell smiddle">	
								<div class="price-data-list-title">상품가격</div>
								<div class="price-data-list-value"><?=number_format($row['product_price']) ?>원</div>
							</div>
							<div class="price-data-list-cell smiddle">	
								<div class="price-data-list-title">+ 배송비</div>
								<div class="price-data-list-value"><?=number_format($row['shipping_price']) ?>원</div>
							</div>
						</div>
					</div>
				</div>
				<div class="basic-data-group vmiddle">
					<div class="con-title-group">
						<h5 class="con-title">포인트사용</h5>
					</div>			
					<div class="price-data-wrap type-2">
						<div class="price-data-group">
							<div class="price-data-list">	
								<div class="price-data-list-cell smiddle">	
									<div class="price-data-list-title">사용한 포인트</div>
									<div class="price-data-list-value"><?=number_format($row['point_price']) ?>원</div>
								</div>
								<div class="price-data-list-cell total line">	
									<div class="price-data-list-title"><span class="font-color-gray">총 결제예정 금액</span></div>
									<div class="price-data-list-value"><?=number_format($row['total_price']) ?>원</div>
								</div>
							</div>
						</div>
					</div>
					
				</div>
			</div>
			<!-- //결제 정보 -->
			<!-- 주문상품 -->
			<div class="basic-data-group">
				<div class="con-title-group">
					<h4 class="con-title">주문상품</h4>
				</div>
				<div class="user-pay-list product_list">
					<div class="user-pay-list-cell">
						<div class="shop-cart-items">
							<div class="shop-cart-body">
								<div class="item-info-wrap">
									<div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
									<div class="item-data">
										<div class="item-data-inner">
											<div class="item-name">[도기프렌드] 수제 간식세트</div>
											<div class="item-option">
												<div>올리브</div>
												<div class="item-option-division">/</div>
												<div>1개</div>
											</div>
											<div class="item-price">7,500원</div>
										</div>
									</div>
									<div class="label label-shop-state">입금대기중</div>
								</div>
							</div>
						</div>
						<button type="button" class="btn btn-middle-size btn-outline-gray btn-round btn-user-pay-action">취소 요청</button>
					</div>
					<div class="user-pay-list-cell">
						<div class="shop-cart-items">
							<div class="shop-cart-body">
								<div class="item-info-wrap">
									<div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
									<div class="item-data">
										<div class="item-data-inner">
											<div class="item-name">[도기프렌드] 수제 간식세트</div>
											<div class="item-option">
												<div>올리브</div>
												<div class="item-option-division">/</div>
												<div>1개</div>
											</div>
											<div class="item-price">7,500원</div>
										</div>
									</div>
									<div class="label label-shop-state">배송준비중</div>
								</div>
							</div>
						</div>
						<button type="button" class="btn btn-middle-size btn-outline-gray btn-round btn-user-pay-action">취소 요청</button>
					</div>
					<div class="user-pay-list-cell">
						<div class="shop-cart-items">
							<div class="shop-cart-body">
								<div class="item-info-wrap">
									<div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
									<div class="item-data">
										<div class="item-data-inner">
											<div class="item-name">[도기프렌드] 수제 간식세트</div>
											<div class="item-option">
												<div>올리브</div>
												<div class="item-option-division">/</div>
												<div>1개</div>
											</div>
											<div class="item-price">7,500원</div>
										</div>
									</div>
									<div class="label label-shop-state">배송중</div>
								</div>
							</div>
						</div>
						<button type="button" class="btn btn-middle-size btn-outline-purple btn-round btn-user-pay-action">수취확인</button>
					</div>
					<div class="user-pay-list-cell">
						<div class="shop-cart-items">
							<div class="shop-cart-body">
								<div class="item-info-wrap">
									<div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
									<div class="item-data">
										<div class="item-data-inner">
											<div class="item-name">[도기프렌드] 수제 간식세트</div>
											<div class="item-option">
												<div>올리브</div>
												<div class="item-option-division">/</div>
												<div>1개</div>
											</div>
											<div class="item-price">7,500원</div>
										</div>
									</div>
									<div class="label label-shop-state"><span class="font-color-purple">배송완료</span></div>
								</div>
							</div>
						</div>
						<div class="grid-layout btn-grid-group btn-user-pay-action">
							<div class="grid-layout-inner">
								<div class="grid-layout-cell grid-2"><button type="button" class="btn btn-purple btn-middle-size btn-round">구매확정</button></div>
								<div class="grid-layout-cell grid-2"><button type="button" class="btn btn-outline-gray btn-middle-size btn-round">반품요청</button></div>
							</div>
						</div>
					</div>
					<div class="user-pay-list-cell">
						<div class="shop-cart-items">
							<div class="shop-cart-body">
								<div class="item-info-wrap">
									<div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
									<div class="item-data">
										<div class="item-data-inner">
											<div class="item-name">[도기프렌드] 수제 간식세트</div>
											<div class="item-option">
												<div>올리브</div>
												<div class="item-option-division">/</div>
												<div>1개</div>
											</div>
											<div class="item-price">7,500원</div>
										</div>
									</div>
									<div class="label label-shop-state"><span class="font-color-red">반품</span></div>
								</div>
							</div>
						</div>
					</div>
					<div class="user-pay-list-cell">
						<div class="shop-cart-items">
							<div class="shop-cart-body">
								<div class="item-info-wrap">
									<div class="item-thumb"><img src="/static/pub/images/user_thumb.png" alt=""></div>
									<div class="item-data">
										<div class="item-data-inner">
											<div class="item-name">[도기프렌드] 수제 간식세트</div>
											<div class="item-option">
												<div>올리브</div>
												<div class="item-option-division">/</div>
												<div>1개</div>
											</div>
											<div class="item-price">7,500원</div>
										</div>
									</div>
									<div class="label label-shop-state"><span class="font-color-red">취소</span></div>
								</div>
							</div>
						</div>
					</div>
				</div>			
				<div class="basic-data-group vmiddle line">
					<div class="price-data-wrap">
						<div class="price-data-group">
							<div class="price-data-list">
                                <?php if($row["pay_type"] == "2"){ ?>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">입금자명</div>
									<div class="price-data-list-value"><?=$row['bank_name'] ?></div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">입금계좌</div>
									<div class="price-data-list-value">신한은행 232-23-2342-1234<br>주) 펫이지</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">입금마감일시</div>
									<div class="price-data-list-value"><?=$expire_dt ?></div>
								</div>
                                <?php } ?>
								<!--<div class="price-data-list-cell read">
									<div class="price-data-list-title">반품사유</div>
									<div class="price-data-list-value">김반짝</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">반품내역</div>
									<div class="price-data-list-value">계좌이체</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">환불은행</div>
									<div class="price-data-list-value">기업은행</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">환불계좌</div>
									<div class="price-data-list-value">232-23-2342-1234</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">환불금액</div>
									<div class="price-data-list-value">4,000원</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">환불일시</div>
									<div class="price-data-list-value">2021.10.08 오전 11:27:30</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">취소사유</div>
									<div class="price-data-list-value">김반짝</div>
								</div>
								<div class="price-data-list-cell read">	
									<div class="price-data-list-title">취소내역</div>
									<div class="price-data-list-value">계좌이체</div>
								</div>-->
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- //주문상품 -->

		</div>
		<!-- //user-pay-view -->  
	</div>
	<!-- //page-body -->	
</section>
<!-- //container -->

<script>
    var $item_order_detail = $('#container');
    var pay_status_arr = $.parseJSON('<?=json_encode($pay_status_arr)?>');
    var order_status_arr = $.parseJSON('<?=json_encode($order_status_arr)?>');
    var pay_status_arr_old = $.parseJSON('<?=json_encode($pay_status_arr_old)?>');
    var reason_type_arr = $.parseJSON('<?=json_encode($reason_type_arr)?>');
    var no = '<?=$order_num ?>';
    $(document).ready(function(){
        get_item_payment_log_product();
    });

    function get_item_payment_log_product(post_data){
        $.ajax({
            url: 'data/item_ajax.php',
            data: {
                mode : "get_item_payment_log_product",
                order_num: no
            },
            type: 'POST',
            dataType: 'JSON',
            success: function(data) {
                if(data.code == "000000"){
                    console.log(data.data);
                    var html = '';

                    $.each(data.data, function(i, v) {
                        var option = JSON.parse(v.option_data);
                        //var img_link = (v.file_path != '')? "https://image.banjjakpet.com"+img_link_change(v.file_path) : v.goodsRepImage;
                        //var img_link = (v.file_path != '' || v.file_path == null)? "https://image.banjjakpet.com"+img_link_change(v.file_path) : v.goodsRepImage;
                        var img_link = (v.file_path == '' || v.file_path == null)? v.goodsRepImage : "https://image.banjjakpet.com"+img_link_change(v.file_path);
                        html += '<div class="user-pay-list-cell">';
                        html += '    <div class="shop-cart-items">';
                        html += '        <div class="shop-cart-body">';
                        html += '            <div class="item-info-wrap">';
                        html += '                <div class="item-thumb"><img src="'+img_link+'" alt=""></div>';
                        html += '                <div class="item-data">';
                        html += '                    <div class="item-data-inner">';
                        html += '                        <div class="item-name">'+v.product_name+'</div>';
                        $.each(option, function(i_,v_){
                            html += '                        <div class="item-option">';
                            html += '                            <div>'+v_.txt+'</div>';
                            html += '                            <div class="item-option-division">/</div>';
                            html += '                            <div>'+v_.amount+'개</div>';
                            html += '                        </div>';
                        });
                        html += '                        <div class="item-price">'+v.product_price+'원</div>';
                        html += '                    </div>';
                        html += '                </div>';
                        html += '                <div class="label label-shop-state">'+pay_status_arr[v.pay_status]+'</div>';
                        html += '            </div>';
                        html += '        </div>';
                        html += '    </div>';
                        if(v.pay_status == "1"){
                            html += '    <button type="button" class="btn btn-middle-size btn-outline-gray btn-round btn-user-pay-action">취소 요청</button>';
                        }else if(v.pay_status == "2"){
                            html += '    <div class="grid-layout btn-grid-group btn-user-pay-action">';
                            html += '        <div class="grid-layout-inner">';
                            html += '           <div class="grid-layout-cell grid-2"><button type="button" class="btn btn-purple btn-middle-size btn-round">배송조회</button></div>';
                            html += '           <div class="grid-layout-cell grid-2"><button type="button" class="btn btn-outline-gray btn-middle-size btn-round">취소요청</button></div>';
                            html += '       </div>';
                            html += '    </div>';
                        }else if(v.pay_status == "3"){
                            html += '    <div class="grid-layout btn-grid-group btn-user-pay-action">';
                            html += '        <div class="grid-layout-inner">';
                            html += '           <div class="grid-layout-cell grid-2"><button type="button" class="btn btn-purple btn-middle-size btn-round">배송조회</button></div>';
                            html += '           <div class="grid-layout-cell grid-2"><button type="button" class="btn btn-outline-gray btn-middle-size btn-round">반품요청</button></div>';
                            html += '       </div>';
                            html += '    </div>';
                        }else if(v.pay_status == "4"){
                            html += '    <button type="button" class="btn btn-middle-size btn-outline-gray btn-round btn-user-pay-action">반품요청</button>';
                        }else if(v.pay_status == "8"){
                            // 반품사유
                        }else if(v.pay_status == "9"){
                            // 취소사유
                        }
                        // html += '    <button type="button" class="btn btn-middle-size btn-outline-gray btn-round btn-user-pay-action">취소 요청</button>';
                        // html += '    <button type="button" class="btn btn-middle-size btn-outline-purple btn-round btn-user-pay-action">수취확인</button>';
                        // html += '    <div class="grid-layout btn-grid-group btn-user-pay-action">';
                        // html += '        <div class="grid-layout-inner">';
                        // html += '           <div class="grid-layout-cell grid-2"><button type="button" class="btn btn-purple btn-middle-size btn-round">구매확정</button></div>';
                        // html += '           <div class="grid-layout-cell grid-2"><button type="button" class="btn btn-outline-gray btn-middle-size btn-round">반품요청</button></div>';
                        // html += '       </div>';
                        // html += '    </div>';
                        // html += '</div>';
                    });
                    $('.product_list').html(html);
                }else{
                    alert(data.data+"("+data.code+")");
                    console.log(data.code);
                }
            },
            error: function(xhr, status, error) {
                alert(error + "네트워크에러");
            }
        });
    }

    // 세자리 숫자 콤마
    Number.prototype.format = function() {
        if (this == 0) return 0;

        var reg = /(^[+-]?\d+)(\d{3})/;
        var n = (this + '');

        while (reg.test(n)) n = n.replace(reg, '$1' + ',' + '$2');

        return n;
    };

    // 문자열 타입에서 쓸 수 있도록 format() 함수 추가
    String.prototype.format = function() {
        var num = parseFloat(this);
        if (isNaN(num)) return "0";

        return num.format();
    };
</script>
	
</body>
</html>
